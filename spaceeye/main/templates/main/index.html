{% extends 'main/base.html' %}

{% block title %}APOD - NASA Explorer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Astronomy Picture of the Day</h1>
        
        <!-- Date Selector -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Select Date</h5>
                <form method="get" class="row g-3">
                    <div class="col-md-6">
                        <label for="date-picker" class="form-label">Pick any date:</label>
                        <div class="input-group">
                            <input type="date" name="date" id="date-picker" class="form-control" 
                                   value="{{ selected_date|default:'' }}" 
                                   max="{% now 'Y-m-d' %}" 
                                   min="1995-06-16">
                            <button type="submit" class="btn btn-primary">Go</button>
                        </div>
                        <small class="form-text text-muted">Available since June 16, 1995</small>
                    </div>
                </form>
            </div>
        </div>

        <!-- APOD Content -->
        <div id="apod-content">
            {% if nasa_data.error %}
                <div class="alert alert-warning">
                    <h4>‚ö†Ô∏è {{ nasa_data.error }}</h4>
                    <p>Please try selecting a different date. Some dates may not have images available.</p>
                </div>
            {% else %}
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-8">
                                {% if nasa_data.media_type == 'image' %}
                                    <div class="image-container mb-3 position-relative">
                                        <img src="{{ nasa_data.url }}"
                                             alt="{{ nasa_data.title }}"
                                             class="img-fluid nasa-image"
                                             loading="lazy">

                                        <!-- Favorite button over image (authenticated users only) -->
                                        {% if user.is_authenticated %}
                                            <button class="favorite-btn btn position-absolute top-0 end-0 m-2
                                                          {% if is_favorited %}btn-warning{% else %}btn-outline-warning{% endif %}"
                                                    data-action="{% if is_favorited %}remove{% else %}add{% endif %}"
                                                    data-type="apod"
                                                    {% if is_favorited %}data-image-url="{{ nasa_data.url }}"{% endif %}
                                                    title="{% if is_favorited %}Remove from favorites{% else %}Add to favorites{% endif %}"
                                                    style="z-index: 10;">
                                                {% if is_favorited %}
                                                    <i class="fas fa-star"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            </button>
                                        {% endif %}
                                    </div>
                                {% elif nasa_data.media_type == 'video' %}
                                    <div class="ratio ratio-16x9 mb-3 position-relative">
                                        <iframe src="{{ nasa_data.url }}"
                                                allowfullscreen
                                                title="{{ nasa_data.title }}">
                                        </iframe>

                                        <!-- Favorite button for video (if thumbnail exists) -->
                                        {% if user.is_authenticated and nasa_data.thumbnail_url %}
                                            <button class="favorite-btn btn position-absolute top-0 end-0 m-2
                                                          {% if is_favorited %}btn-warning{% else %}btn-outline-warning{% endif %}"
                                                    data-action="{% if is_favorited %}remove{% else %}add{% endif %}"
                                                    data-type="apod"
                                                    {% if is_favorited %}data-image-url="{{ nasa_data.thumbnail_url }}"{% endif %}
                                                    title="{% if is_favorited %}Remove from favorites{% else %}Add to favorites{% endif %}"
                                                    style="z-index: 10;">
                                                {% if is_favorited %}
                                                    <i class="fas fa-star"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            </button>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-lg-4">
                                <h2 class="card-title nasa-title">{{ nasa_data.title }}</h2>
                                <p class="text-muted mb-3">
                                    <strong>üìÖ {{ nasa_data.date }}</strong>
                                </p>

                                <!-- Action buttons -->
                                <div class="mb-3 d-flex gap-2 flex-wrap">
                                    {% if nasa_data.media_type == 'image' and nasa_data.hdurl %}
                                        <a href="{{ nasa_data.hdurl }}"
                                           target="_blank"
                                           class="btn btn-primary">
                                            üîç View HD Version
                                        </a>
                                    {% endif %}

                                    {% if user.is_authenticated %}
                                        <!-- Large favorite button -->
                                        <button class="favorite-btn btn
                                                      {% if is_favorited %}btn-warning{% else %}btn-outline-warning{% endif %}"
                                                data-action="{% if is_favorited %}remove{% else %}add{% endif %}"
                                                data-type="apod"
                                                {% if is_favorited %}data-image-url="{{ nasa_data.url }}"{% endif %}
                                                title="{% if is_favorited %}Remove from favorites{% else %}Add to favorites{% endif %}">
                                            {% if is_favorited %}
                                                <i class="fas fa-star"></i> Favorited
                                            {% else %}
                                                <i class="far fa-star"></i> Add to Favorites
                                            {% endif %}
                                        </button>
                                    {% else %}
                                        <!-- Login prompt -->
                                        <a href="{% url 'login' %}" class="btn btn-outline-secondary">
                                            <i class="fas fa-sign-in-alt"></i> Login to save
                                        </a>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <h6>Description:</h6>
                                    <p class="card-text nasa-explanation">{{ nasa_data.explanation }}</p>
                                </div>

                                {% if nasa_data.copyright %}
                                    <p class="text-muted">
                                        <small><strong>¬©</strong> {{ nasa_data.copyright }}</small>
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Script to pass APOD data to JavaScript -->
{% if not nasa_data.error %}
<script>
    window.currentApodData = {
        title: "{{ nasa_data.title|escapejs }}",
        explanation: "{{ nasa_data.explanation|escapejs }}",
        url: "{{ nasa_data.url|escapejs }}",
        date: "{{ nasa_data.date|escapejs }}",
        media_type: "{{ nasa_data.media_type|escapejs }}"
        {% if nasa_data.hdurl %},hdurl: "{{ nasa_data.hdurl|escapejs }}"{% endif %}
        {% if nasa_data.copyright %},copyright: "{{ nasa_data.copyright|escapejs }}"{% endif %}
        {% if nasa_data.thumbnail_url %},thumbnail_url: "{{ nasa_data.thumbnail_url|escapejs }}"{% endif %}
    };
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function navigateDate(days) {
    const currentDate = new Date('{{ selected_date|default:"" }}' || new Date());
    currentDate.setDate(currentDate.getDate() + days);

    const minDate = new Date('1995-06-16');
    const maxDate = new Date();

    if (currentDate >= minDate && currentDate <= maxDate) {
        const dateString = currentDate.toISOString().split('T')[0];
        window.location.href = `?date=${dateString}`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const cardBody = document.querySelector('#apod-content .card-body');
    if (cardBody && !document.querySelector('.date-navigation')) {
        const nav = document.createElement('div');
        nav.className = 'date-navigation text-center mt-3';
        nav.innerHTML = `
            <button class="btn btn-outline-secondary btn-sm me-2" onclick="navigateDate(-1)">
                ‚Üê Previous Day
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="navigateDate(1)">
                Next Day ‚Üí
            </button>
        `;
        cardBody.appendChild(nav);
    }
});
</script>
{% endblock %}